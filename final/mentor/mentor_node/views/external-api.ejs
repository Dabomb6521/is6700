<!-- Page Title -->
<div class="page-title" data-aos="fade">
  <div class="heading">
    <div class="container">
      <div class="row d-flex justify-content-center text-center">
        <div class="col-lg-8">
          <h1>Spotify Song Requests</h1>
          <p class="mb-0">Search for songs and add them to the request list</p>
        </div>
      </div>
    </div>
  </div>
  <nav class="breadcrumbs">
    <div class="container">
      <ol>
        <li><a href="/">Home</a></li>
        <li class="current">Spotify Integration</li>
      </ol>
    </div>
  </nav>
</div>
<!-- End Page Title -->

<!-- Main Section -->
<section class="section">
  <div class="container">
    
    <!-- Search Section -->
    <div class="row mb-5">
      <div class="col-lg-12">
        <h2 class="mb-4">Search for Songs</h2>
        <form action="/externalapi/search" method="post" class="row g-3">
          <div class="col-md-10">
            <input 
              type="text" 
              class="form-control" 
              name="query" 
              placeholder="Search by song name or artist..." 
              required
            />
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Search Results Section -->
<% if (searchResults.length > 0) { %>
<div class="row mb-5">
  <div class="col-lg-12">
    <h3 class="mb-4">Search Results</h3>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Album Art</th>
            <th>Song</th>
            <th>Artist</th>
            <th>Album</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% searchResults.forEach(track => { %>
            <tr>
              <td>
                <img src="<%= track.image %>" alt="<%= track.name %>" style="width: 60px; height: 60px; object-fit: cover;">
              </td>
              <td><strong><%= track.name %></strong></td>
              <td><%= track.artist %></td>
              <td><%= track.album %></td>
              <td>
                <a href="<%= track.spotifyUrl %>" target="_blank" class="btn btn-sm btn-success">
                  <i class="bi bi-spotify"></i>
                </a>
                <form action="/externalapi/request" method="post" style="display: inline;">
                  <input type="hidden" name="spotifyId" value="<%= track.id %>">
                  <input type="hidden" name="songName" value="<%= track.name %>">
                  <input type="hidden" name="artistName" value="<%= track.artist %>">
                  <input type="hidden" name="albumName" value="<%= track.album %>">
                  <input type="hidden" name="imageUrl" value="<%= track.image %>">
                  <input type="hidden" name="spotifyUrl" value="<%= track.spotifyUrl %>">
                  <button type="submit" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Request
                  </button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<% } %>

    <!-- Song Requests Section -->
    <div class="row mb-5">
      <div class="col-lg-12">
        <h3 class="mb-4">Requested Songs</h3>
        <% if (songRequests.length === 0) { %>
          <div class="alert alert-info">
            No songs have been requested yet. Be the first to request a song!
          </div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Album Art</th>
                  <th>Song</th>
                  <th>Artist</th>
                  <th>Requested By</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% songRequests.forEach(request => { %>
                  <tr>
                    <td>
                      <img src="<%= request.imageUrl %>" alt="<%= request.songName %>" style="width: 50px; height: 50px; object-fit: cover;">
                    </td>
                    <td><%= request.songName %></td>
                    <td><%= request.artistName %></td>
                    <td>
                      <% if (request.requestedBy) { %>
                        <%= request.requestedBy.firstName %> <%= request.requestedBy.lastName %>
                      <% } else { %>
                        Anonymous
                      <% } %>
                    </td>
                    <td><%= new Date(request.requestedAt).toLocaleDateString() %></td>
                    <td>
                      <a href="<%= request.spotifyUrl %>" target="_blank" class="btn btn-sm btn-success">
                        <i class="bi bi-spotify"></i>
                      </a>
                      <% if (user && request.requestedBy && user._id.toString() === request.requestedBy._id.toString() || (user.roles && user.roles.includes('admin'))) { %>
                        <form action="/externalapi/request/remove/<%= request._id %>" method="post" style="display: inline;">
                          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Remove this song request?')">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Random Songs Section -->
    <div class="row">
      <div class="col-lg-12">
        <h3 class="mb-4">Random 20 Tracks From My Country Playlist</h3>
        <div class="row gy-4">
          <% topTracks.forEach((track, index) => { %>
            <div class="col-md-4 col-lg-3">
              <div class="card h-100">
                <div class="position-relative">
                  <img src="<%= track.image %>" class="card-img-top" alt="<%= track.name %>">
                  <span class="position-absolute top-0 start-0 badge bg-primary m-2" style="font-size: 1.2rem;">
                    #<%= index + 1 %>
                  </span>
                </div>
                <div class="card-body">
                  <h5 class="card-title"><%= track.name %></h5>
                  <p class="card-text">
                    <strong>Artist:</strong> <%= track.artist %><br>
                    <strong>Album:</strong> <%= track.album %>
                  </p>
                  <div class="d-flex gap-2">
                    <a href="<%= track.spotifyUrl %>" target="_blank" class="btn btn-sm btn-success">
                      <i class="bi bi-spotify"></i> Open in Spotify
                    </a>
                    <form action="/externalapi/request" method="post" style="display: inline;">
                      <input type="hidden" name="spotifyId" value="<%= track.id %>">
                      <input type="hidden" name="songName" value="<%= track.name %>">
                      <input type="hidden" name="artistName" value="<%= track.artist %>">
                      <input type="hidden" name="albumName" value="<%= track.album %>">
                      <input type="hidden" name="imageUrl" value="<%= track.image %>">
                      <input type="hidden" name="spotifyUrl" value="<%= track.spotifyUrl %>">
                      <button type="submit" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Request
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

  </div>
</section>
<!-- /Main Section -->